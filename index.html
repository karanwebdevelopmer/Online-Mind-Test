<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß† Brain Challenge Pro - FIXED VERSION</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ... ‡§∏‡§≠‡•Ä CSS ‡§µ‡§π‡•Ä ‡§∞‡§π‡•á‡§ó‡§æ ... */
        /* CSS unchanged from your original code */
        :root {
            --primary: #7B68EE;
            --secondary: #00D4FF;
            --background: #0F0F23;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: var(--background);
            color: white;
            min-height: 100vh;
        }
        
        .loading {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--background);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .login-screen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, #0F0F23, #1a1a2e);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 9998;
        }
        
        .login-box {
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            width: 100%;
            backdrop-filter: blur(10px);
        }
        
        .login-title {
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--secondary);
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .auth-tab {
            flex: 1;
            padding: 10px;
            background: none;
            border: none;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            font-size: 1rem;
        }
        
        .auth-tab.active {
            color: var(--secondary);
            border-bottom: 2px solid var(--secondary);
        }
        
        .auth-form {
            display: none;
        }
        
        .auth-form.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: rgba(255,255,255,0.8);
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: white;
            font-size: 1rem;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--secondary);
        }
        
        .error-message {
            color: #FF6B8B;
            font-size: 0.9rem;
            margin-top: 5px;
            display: none;
        }
        
        .auth-btn {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: white;
        }
        
        .btn-guest {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .game-container {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            flex-direction: column;
        }
        
        .header {
            background: rgba(15,15,35,0.9);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 70px;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        .welcome {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
        }
        
        .card:hover {
            background: rgba(123,104,238,0.1);
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .stat {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--secondary);
            margin-bottom: 5px;
        }
        
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .timer {
            font-size: 2.5rem;
            font-weight: bold;
            text-align: center;
            color: var(--secondary);
            margin: 20px 0;
        }
        
        .question-box {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        
        .options {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }
        
        .option {
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            color: white;
            text-align: left;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .option:hover {
            background: rgba(123,104,238,0.1);
        }
        
        .room-list {
            margin-top: 20px;
        }
        
        .room-item {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .room-code {
            font-family: monospace;
            background: var(--primary);
            padding: 5px 10px;
            border-radius: 5px;
            margin: 0 10px;
        }
        
        .nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(15,15,35,0.9);
            padding: 10px;
            display: flex;
            justify-content: space-around;
        }
        
        .nav-btn {
            background: none;
            border: none;
            color: rgba(255,255,255,0.7);
            padding: 10px;
            cursor: pointer;
            text-align: center;
        }
        
        .nav-btn.active {
            color: var(--secondary);
        }
        
        .btn {
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .copy-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
        }
        
        .player-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .waiting-room {
            text-align: center;
            padding: 20px;
        }
        
        .player-list {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .player-item {
            text-align: center;
            min-width: 100px;
        }
        
        .hidden {
            display: none !important;
        }
        
        .text-center {
            text-align: center;
        }
        
        .mb-2 {
            margin-bottom: 20px;
        }
        
        .mt-2 {
            margin-top: 20px;
        }
        
        /* New styles for game */
        .correct {
            background: rgba(0, 255, 157, 0.2) !important;
            border-color: #00FF9D !important;
        }
        
        .wrong {
            background: rgba(255, 107, 139, 0.2) !important;
            border-color: #FF6B8B !important;
        }
        
        .game-over {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
        }
    </style>
    
    <!-- Firebase SDK v8 (Compatible) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading" id="loadingScreen">
        <div class="spinner"></div>
        <div>Loading Brain Challenge Pro...</div>
    </div>
    
    <!-- Login/Signup Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <div style="font-size: 3rem; color: var(--secondary); margin-bottom: 20px;">
                <i class="fas fa-brain"></i>
            </div>
            <h1 class="login-title">Brain Challenge Pro</h1>
            <p style="margin-bottom: 20px; color: rgba(255,255,255,0.8);">
                Create account or login to play
            </p>
            
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showAuthForm('login')">Login</button>
                <button class="auth-tab" onclick="showAuthForm('signup')">Sign Up</button>
            </div>
            
            <!-- Login Form -->
            <div class="auth-form active" id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" class="form-input" placeholder="Enter your email">
                    <div class="error-message" id="loginEmailError"></div>
                </div>
                
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" class="form-input" placeholder="Enter your password">
                    <div class="error-message" id="loginPasswordError"></div>
                </div>
                
                <button class="auth-btn btn-primary" onclick="loginWithEmail()">
                    <i class="fas fa-sign-in-alt"></i>
                    Login
                </button>
            </div>
            
            <!-- Signup Form -->
            <div class="auth-form" id="signupForm">
                <div class="form-group">
                    <label for="signupUsername">Username (Unique)</label>
                    <input type="text" id="signupUsername" class="form-input" placeholder="Choose a unique username">
                    <div class="error-message" id="signupUsernameError"></div>
                </div>
                
                <div class="form-group">
                    <label for="signupEmail">Email</label>
                    <input type="email" id="signupEmail" class="form-input" placeholder="Enter your email">
                    <div class="error-message" id="signupEmailError"></div>
                </div>
                
                <div class="form-group">
                    <label for="signupPassword">Password</label>
                    <input type="password" id="signupPassword" class="form-input" placeholder="Enter password">
                    <div class="error-message" id="signupPasswordError"></div>
                </div>
                
                <div class="form-group">
                    <label for="signupConfirmPassword">Confirm Password</label>
                    <input type="password" id="signupConfirmPassword" class="form-input" placeholder="Confirm password">
                    <div class="error-message" id="signupConfirmError"></div>
                </div>
                
                <button class="auth-btn btn-primary" onclick="signupWithEmail()">
                    <i class="fas fa-user-plus"></i>
                    Create Account
                </button>
            </div>
            
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                <button class="auth-btn btn-guest" onclick="loginAsGuest()">
                    <i class="fas fa-user-secret"></i>
                    Play as Guest
                </button>
            </div>
        </div>
    </div>
    
    <!-- Game Container -->
    <div class="game-container" id="gameContainer">
        <!-- Header -->
        <div class="header">
            <div style="font-size: 1.2rem; font-weight: bold; color: var(--secondary);">
                <i class="fas fa-brain"></i> BrainPro
            </div>
            <div style="font-weight: bold; display: flex; align-items: center; gap: 10px;">
                <div class="player-avatar" id="userAvatar">G</div>
                <div id="userName">Guest</div>
            </div>
        </div>
        
        <!-- Content -->
        <div class="content" id="contentArea">
            <!-- Home Page -->
            <div class="page active" id="homePage">
                <div class="welcome">
                    <h1 id="welcomeText">Welcome!</h1>
                    <p style="color: rgba(255,255,255,0.7);">Test your knowledge</p>
                </div>
                
                <div class="grid">
                    <div class="card" onclick="goToPage('single')">
                        <div style="font-size: 2rem; margin-bottom: 10px;">üß†</div>
                        <div style="font-weight: bold;">Single Player</div>
                    </div>
                    
                    <div class="card" onclick="goToPage('multi')">
                        <div style="font-size: 2rem; margin-bottom: 10px;">üéÆ</div>
                        <div style="font-weight: bold;">Multiplayer</div>
                    </div>
                    
                    <div class="card" onclick="goToPage('friends')">
                        <div style="font-size: 2rem; margin-bottom: 10px;">üë•</div>
                        <div style="font-weight: bold;">Friends</div>
                    </div>
                    
                    <div class="card" onclick="goToPage('profile')">
                        <div style="font-size: 2rem; margin-bottom: 10px;">üë§</div>
                        <div style="font-weight: bold;">Profile</div>
                    </div>
                </div>
                
                <div class="stats">
                    <div class="stat">
                        <div class="stat-value" id="statWins">0</div>
                        <div>Wins</div>
                    </div>
                    
                    <div class="stat">
                        <div class="stat-value" id="statGames">0</div>
                        <div>Games</div>
                    </div>
                    
                    <div class="stat">
                        <div class="stat-value" id="statLevel">1</div>
                        <div>Level</div>
                    </div>
                    
                    <div class="stat">
                        <div class="stat-value" id="statPoints">0</div>
                        <div>Points</div>
                    </div>
                </div>
            </div>
            
            <!-- Single Player Page -->
            <div class="page" id="singlePage">
                <div style="margin-bottom: 20px;">
                    <button class="btn" onclick="goToPage('home')" style="width: auto; padding: 10px 15px; background: rgba(255,255,255,0.1); color: white;">
                        ‚Üê Back
                    </button>
                </div>
                
                <h2 style="margin-bottom: 20px;">Single Player</h2>
                
                <div class="grid">
                    <div class="card" onclick="startGame('easy')">
                        <div style="color: #00FF9D; font-size: 2rem; margin-bottom: 10px;">üå±</div>
                        <div style="font-weight: bold;">Easy</div>
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">5 questions</div>
                    </div>
                    
                    <div class="card" onclick="startGame('medium')">
                        <div style="color: #FFD166; font-size: 2rem; margin-bottom: 10px;">‚öñÔ∏è</div>
                        <div style="font-weight: bold;">Medium</div>
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">7 questions</div>
                    </div>
                    
                    <div class="card" onclick="startGame('hard')">
                        <div style="color: #FF6B8B; font-size: 2rem; margin-bottom: 10px;">üî•</div>
                        <div style="font-weight: bold;">Hard</div>
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">10 questions</div>
                    </div>
                </div>
            </div>
            
            <!-- Multiplayer Page -->
            <div class="page" id="multiPage">
                <div style="margin-bottom: 20px;">
                    <button class="btn" onclick="goToPage('home')" style="width: auto; padding: 10px 15px; background: rgba(255,255,255,0.1); color: white;">
                        ‚Üê Back
                    </button>
                </div>
                
                <h2 style="margin-bottom: 20px;">Multiplayer</h2>
                
                <button class="btn btn-primary" onclick="createRoom()">
                    <i class="fas fa-plus"></i> Create Room
                </button>
                
                <div style="margin: 20px 0;">
                    <input type="text" id="roomCodeInput" placeholder="Enter Room Code (e.g., ABC123)" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: white; margin-bottom: 15px;">
                    
                    <button class="btn" onclick="joinRoom()" style="background: rgba(255,255,255,0.1); color: white;">
                        <i class="fas fa-sign-in-alt"></i> Join Room
                    </button>
                </div>
                
                <div class="room-list">
                    <h3 style="margin: 20px 0 10px 0;">Active Rooms</h3>
                    <div id="roomsContainer">
                        <!-- Rooms will be listed here -->
                    </div>
                </div>
            </div>
            
            <!-- Waiting Room Page -->
            <div class="page" id="waitingPage">
                <div class="waiting-room">
                    <h2 style="margin-bottom: 20px;">Waiting Room</h2>
                    
                    <div style="font-size: 1.5rem; padding: 15px; display: inline-block; margin-bottom: 20px;">
                        <span id="roomCodeDisplay" style="background: var(--primary); padding: 10px 20px; border-radius: 10px;">ABC123</span>
                        <button class="copy-btn" onclick="copyRoomCode()">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                    
                    <p style="margin-bottom: 30px; color: rgba(255,255,255,0.7);">
                        Share this code with your friend to join
                    </p>
                    
                    <h3 style="margin-bottom: 20px;">Players</h3>
                    
                    <div class="player-list" id="playerList">
                        <!-- Players will be shown here -->
                    </div>
                    
                    <div id="waitingMessage" style="margin: 20px 0; color: #FFD166;">
                        Waiting for another player to join...
                    </div>
                    
                    <button class="btn" onclick="startMultiplayerGame()" style="background: var(--primary); color: white; display: none;" id="startGameBtn">
                        <i class="fas fa-play"></i> Start Game
                    </button>
                    
                    <button class="btn" onclick="leaveRoom()" style="background: rgba(255,255,255,0.1); color: white; margin-top: 10px;">
                        <i class="fas fa-sign-out-alt"></i> Leave Room
                    </button>
                </div>
            </div>
            
            <!-- Game Page -->
            <div class="page" id="gamePage">
                <div class="game-header">
                    <div style="text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: bold;" id="playerScore">0</div>
                        <div style="font-size: 0.9rem;">You</div>
                    </div>
                    
                    <div style="font-size: 1.2rem; font-weight: bold;">VS</div>
                    
                    <div style="text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: bold;" id="opponentScore">0</div>
                        <div style="font-size: 0.9rem;" id="opponentName">Opponent</div>
                    </div>
                </div>
                
                <div class="timer" id="timer">20</div>
                
                <div class="question-box">
                    <div id="questionText">Loading question...</div>
                </div>
                
                <div class="options" id="optionsGrid">
                    <!-- Options will be loaded here -->
                </div>
            </div>
            
            <!-- Profile Page -->
            <div class="page" id="profilePage">
                <div style="margin-bottom: 20px;">
                    <button class="btn" onclick="goToPage('home')" style="width: auto; padding: 10px 15px; background: rgba(255,255,255,0.1); color: white;">
                        ‚Üê Back
                    </button>
                </div>
                
                <h2 style="margin-bottom: 20px;">Profile</h2>
                
                <div style="text-align: center; margin-bottom: 30px;">
                    <div class="player-avatar" style="width: 100px; height: 100px; font-size: 2.5rem; margin: 0 auto 15px;" id="profileAvatar">
                        G
                    </div>
                    <div style="font-size: 1.5rem; font-weight: bold;" id="profileName">Guest</div>
                    <div style="color: rgba(255,255,255,0.7); margin-top: 5px;" id="profileEmail"></div>
                </div>
                
                <div class="stats">
                    <div class="stat">
                        <div class="stat-value" id="profileWins">0</div>
                        <div>Wins</div>
                    </div>
                    
                    <div class="stat">
                        <div class="stat-value" id="profileGames">0</div>
                        <div>Games</div>
                    </div>
                    
                    <div class="stat">
                        <div class="stat-value" id="profileLevel">1</div>
                        <div>Level</div>
                    </div>
                    
                    <div class="stat">
                        <div class="stat-value" id="profilePoints">0</div>
                        <div>Points</div>
                    </div>
                </div>
                
                <button class="btn" onclick="logout()" style="margin-top: 20px; background: #FF6B8B; color: white;">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
        
        <!-- Navigation -->
        <div class="nav">
            <button class="nav-btn active" onclick="goToPage('home')">
                <i class="fas fa-home"></i>
                <div style="font-size: 0.8rem;">Home</div>
            </button>
            
            <button class="nav-btn" onclick="goToPage('single')">
                <i class="fas fa-brain"></i>
                <div style="font-size: 0.8rem;">Practice</div>
            </button>
            
            <button class="nav-btn" onclick="goToPage('multi')">
                <i class="fas fa-gamepad"></i>
                <div style="font-size: 0.8rem;">Play</div>
            </button>
            
            <button class="nav-btn" onclick="goToPage('profile')">
                <i class="fas fa-user"></i>
                <div style="font-size: 0.8rem;">Profile</div>
            </button>
        </div>
    </div>

    <!-- ===== FIXED GAME SCRIPT ===== -->
    <script>
        // ===== FIXED CONFIGURATION =====
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyDNPPyl0AJiD6T78bnYOtBgwD_T_o5lMvM",
            authDomain: "mind-test-game.firebaseapp.com",
            databaseURL: "https://mind-test-game-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "mind-test-game",
            storageBucket: "mind-test-game.firebasestorage.app",
            messagingSenderId: "1043047119163",
            appId: "1:1043047119163:web:3b6e836b38481467a81f1e",
            measurementId: "G-Z2XY3W4R66"
        };
        
        // ===== INITIALIZE FIREBASE =====
        const app = firebase.initializeApp(FIREBASE_CONFIG);
        const auth = firebase.auth();
        const database = firebase.database();
        
        // ===== GAME STATE =====
        const gameState = {
            user: null,
            userData: null,
            questions: [],
            currentQuestion: 0,
            score: 0,
            opponentScore: 0,
            opponentName: '',
            timer: null,
            currentRoom: null,
            roomRef: null,
            gameMode: 'single',
            multiplayerGameStarted: false,
            roomListener: null,
            playerReady: false
        };
        
        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Brain Challenge Pro Initializing...");
            
            // Hide loading after 1.5 seconds
            setTimeout(() => {
                document.getElementById('loadingScreen').classList.add('hidden');
            }, 1500);
            
            // Check for saved user session
            checkSavedSession();
        });
        
        async function checkSavedSession() {
            const savedUser = localStorage.getItem('brainGameUser');
            if (savedUser) {
                try {
                    const userData = JSON.parse(savedUser);
                    
                    if (userData.uid && userData.uid.startsWith('guest_')) {
                        // Guest user
                        gameState.user = userData;
                        showGame();
                        updateUserDisplay();
                        loadUserData();
                    } else if (userData.email) {
                        // Try auto login (without password for safety)
                        showGame();
                        // Load basic data from localStorage
                        if (userData.username) {
                            gameState.user = userData;
                            gameState.userData = userData;
                            updateUserDisplay();
                            updateStatsUI(userData);
                        }
                    }
                } catch (e) {
                    console.log("Error loading saved session:", e);
                }
            }
        }
        
        // ===== AUTH FUNCTIONS =====
        function showAuthForm(formType) {
            // Update tabs
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Show selected form
            document.querySelectorAll('.auth-form').forEach(form => {
                form.classList.remove('active');
            });
            document.getElementById(formType + 'Form').classList.add('active');
            
            // Clear errors
            document.querySelectorAll('.error-message').forEach(error => {
                error.style.display = 'none';
                error.textContent = '';
            });
        }
        
        function showError(fieldId, message) {
            const errorElement = document.getElementById(fieldId + 'Error');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }
        
        function hideError(fieldId) {
            const errorElement = document.getElementById(fieldId + 'Error');
            errorElement.style.display = 'none';
            errorElement.textContent = '';
        }
        
        async function checkUsernameUnique(username) {
            try {
                const usersRef = database.ref('usernames');
                const snapshot = await usersRef.child(username).once('value');
                return !snapshot.exists();
            } catch (error) {
                console.error("Error checking username:", error);
                return false;
            }
        }
        
        async function signupWithEmail() {
            const username = document.getElementById('signupUsername').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;
            
            // Clear previous errors
            ['signupUsername', 'signupEmail', 'signupPassword', 'signupConfirm'].forEach(hideError);
            
            // Validation
            if (!username) {
                showError('signupUsername', 'Username is required');
                return;
            }
            
            if (username.length < 3) {
                showError('signupUsername', 'Username must be at least 3 characters');
                return;
            }
            
            if (!email) {
                showError('signupEmail', 'Email is required');
                return;
            }
            
            if (!password) {
                showError('signupPassword', 'Password is required');
                return;
            }
            
            if (password.length < 6) {
                showError('signupPassword', 'Password must be at least 6 characters');
                return;
            }
            
            if (password !== confirmPassword) {
                showError('signupConfirm', 'Passwords do not match');
                return;
            }
            
            showLoading(true);
            
            try {
                // Create user in Firebase Auth
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Create user profile in database
                const userData = {
                    uid: user.uid,
                    username: username,
                    email: email,
                    displayName: username,
                    wins: 0,
                    games: 0,
                    points: 0,
                    level: 1,
                    createdAt: Date.now(),
                    lastLogin: Date.now()
                };
                
                // Save username reference
                await database.ref('usernames/' + username).set(user.uid);
                
                // Save user data
                await database.ref('users/' + user.uid).set(userData);
                
                // Save session locally
                localStorage.setItem('brainGameUser', JSON.stringify({
                    uid: user.uid,
                    email: email,
                    username: username,
                    displayName: username
                }));
                
                localStorage.setItem('brainGameData', JSON.stringify(userData));
                
                gameState.user = user;
                gameState.userData = userData;
                
                showLoading(false);
                showGame();
                updateUserDisplay();
                updateStatsUI(userData);
                
                alert(`Account created successfully! Welcome ${username}!`);
                
            } catch (error) {
                showLoading(false);
                console.error("Signup error:", error);
                
                if (error.code === 'auth/email-already-in-use') {
                    showError('signupEmail', 'Email already in use');
                } else if (error.code === 'auth/invalid-email') {
                    showError('signupEmail', 'Invalid email address');
                } else if (error.code === 'auth/weak-password') {
                    showError('signupPassword', 'Password is too weak');
                } else {
                    showError('signupEmail', 'Error creating account. Please try again.');
                }
            }
        }
        
        async function loginWithEmail() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            // Clear errors
            ['loginEmail', 'loginPassword'].forEach(hideError);
            
            // Validation
            if (!email) {
                showError('loginEmail', 'Email is required');
                return;
            }
            
            if (!password) {
                showError('loginPassword', 'Password is required');
                return;
            }
            
            showLoading(true);
            
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Get user data from database
                const userRef = database.ref('users/' + user.uid);
                const snapshot = await userRef.once('value');
                let userData = snapshot.val();
                
                if (!userData) {
                    // Create basic user data if not exists
                    userData = {
                        uid: user.uid,
                        email: user.email,
                        username: user.email.split('@')[0],
                        displayName: user.email.split('@')[0],
                        wins: 0,
                        games: 0,
                        points: 0,
                        level: 1,
                        createdAt: Date.now(),
                        lastLogin: Date.now()
                    };
                    await userRef.set(userData);
                } else {
                    // Update last login
                    await userRef.update({ lastLogin: Date.now() });
                }
                
                // Save session locally
                localStorage.setItem('brainGameUser', JSON.stringify({
                    uid: user.uid,
                    email: email,
                    username: userData.username,
                    displayName: userData.displayName
                }));
                
                localStorage.setItem('brainGameData', JSON.stringify(userData));
                
                gameState.user = user;
                gameState.userData = userData;
                
                showLoading(false);
                showGame();
                updateUserDisplay();
                updateStatsUI(userData);
                
            } catch (error) {
                showLoading(false);
                console.error("Login error:", error);
                
                if (error.code === 'auth/user-not-found') {
                    showError('loginEmail', 'No account found with this email');
                } else if (error.code === 'auth/wrong-password') {
                    showError('loginPassword', 'Incorrect password');
                } else if (error.code === 'auth/invalid-email') {
                    showError('loginEmail', 'Invalid email address');
                } else {
                    showError('loginEmail', 'Login failed. Please try again.');
                }
            }
        }
        
        async function loginAsGuest() {
            showLoading(true);
            
            try {
                // Create guest account
                const guestId = 'guest_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                const guestName = 'Guest' + Math.floor(Math.random() * 10000);
                
                gameState.user = {
                    uid: guestId,
                    displayName: guestName,
                    email: null,
                    isAnonymous: true
                };
                
                // Create guest data
                const guestData = {
                    uid: guestId,
                    username: guestName,
                    displayName: guestName,
                    isGuest: true,
                    wins: 0,
                    games: 0,
                    points: 0,
                    level: 1,
                    createdAt: Date.now()
                };
                
                // Save locally
                localStorage.setItem('brainGameUser', JSON.stringify(guestData));
                localStorage.setItem('brainGameData', JSON.stringify(guestData));
                
                gameState.userData = guestData;
                
                showLoading(false);
                showGame();
                updateUserDisplay();
                updateStatsUI(guestData);
                
            } catch (error) {
                showLoading(false);
                console.error("Guest login error:", error);
                alert("Error creating guest account. Please try again.");
            }
        }
        
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                if (gameState.currentRoom) {
                    leaveRoom();
                }
                
                auth.signOut();
                localStorage.removeItem('brainGameUser');
                localStorage.removeItem('brainGameData');
                location.reload();
            }
        }
        
        // ===== UI FUNCTIONS =====
        function showLoading(show) {
            document.getElementById('loadingScreen').classList.toggle('hidden', !show);
        }
        
        function showLogin() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('gameContainer').style.display = 'none';
        }
        
        function showGame() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'flex';
        }
        
        function updateUserDisplay() {
            if (!gameState.userData) return;
            
            const displayName = gameState.userData.displayName || gameState.userData.username || 'Guest';
            const email = gameState.userData.email || '';
            const firstLetter = displayName.charAt(0).toUpperCase();
            
            // Update avatar
            document.getElementById('userAvatar').textContent = firstLetter;
            document.getElementById('profileAvatar').textContent = firstLetter;
            
            // Update text
            document.getElementById('userName').textContent = displayName;
            document.getElementById('welcomeText').textContent = `Welcome, ${displayName}!`;
            document.getElementById('profileName').textContent = displayName;
            document.getElementById('profileEmail').textContent = email;
        }
        
        // ===== PAGE NAVIGATION =====
        function goToPage(page) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(p => {
                p.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(page + 'Page').classList.add('active');
            
            // Update nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const navBtns = document.querySelectorAll('.nav-btn');
            const pageIndex = ['home', 'single', 'multi', 'profile'].indexOf(page);
            if (pageIndex !== -1) {
                navBtns[pageIndex].classList.add('active');
            }
            
            // Special actions
            if (page === 'multi') {
                loadActiveRooms();
            }
        }
        
        // ===== USER DATA =====
        async function loadUserData() {
            if (!gameState.user) return;
            
            try {
                // For real users, load from Firebase
                if (!gameState.user.isAnonymous && gameState.user.uid) {
                    const userRef = database.ref('users/' + gameState.user.uid);
                    
                    userRef.on('value', function(snapshot) {
                        const data = snapshot.val();
                        if (data) {
                            gameState.userData = data;
                            updateStatsUI(data);
                        } else {
                            createUserData();
                        }
                    });
                } else {
                    // For guests, load from local storage
                    const localData = localStorage.getItem('brainGameData');
                    if (localData) {
                        gameState.userData = JSON.parse(localData);
                        updateStatsUI(gameState.userData);
                    } else {
                        createUserData();
                    }
                }
            } catch (error) {
                console.error("Error loading user data:", error);
            }
        }
        
        async function createUserData() {
            if (!gameState.user) return;
            
            const userData = {
                uid: gameState.user.uid,
                username: gameState.user.displayName || 'Guest',
                displayName: gameState.user.displayName || 'Guest',
                email: gameState.user.email || '',
                wins: 0,
                games: 0,
                points: 0,
                level: 1,
                createdAt: Date.now(),
                isGuest: gameState.user.isAnonymous || false
            };
            
            gameState.userData = userData;
            
            try {
                if (!gameState.user.isAnonymous) {
                    await database.ref('users/' + gameState.user.uid).set(userData);
                } else {
                    localStorage.setItem('brainGameData', JSON.stringify(userData));
                }
                
                updateStatsUI(userData);
            } catch (error) {
                console.error("Error creating user data:", error);
            }
        }
        
        async function updateUserStats(updates) {
            if (!gameState.userData) return;
            
            // Update local data
            Object.assign(gameState.userData, updates);
            updateStatsUI(gameState.userData);
            
            try {
                // Save to appropriate storage
                if (!gameState.user.isAnonymous) {
                    await database.ref('users/' + gameState.user.uid).update(updates);
                } else {
                    localStorage.setItem('brainGameData', JSON.stringify(gameState.userData));
                }
            } catch (error) {
                console.error("Error updating stats:", error);
            }
        }
        
        function updateStatsUI(data) {
            // Update home page
            document.getElementById('statWins').textContent = data.wins || 0;
            document.getElementById('statGames').textContent = data.games || 0;
            document.getElementById('statLevel').textContent = data.level || 1;
            document.getElementById('statPoints').textContent = data.points || 0;
            
            // Update profile page
            document.getElementById('profileWins').textContent = data.wins || 0;
            document.getElementById('profileGames').textContent = data.games || 0;
            document.getElementById('profileLevel').textContent = data.level || 1;
            document.getElementById('profilePoints').textContent = data.points || 0;
        }
        
        // ===== QUESTION GENERATION =====
        function getLocalQuestions(count, difficulty) {
            const allQuestions = [
                {
                    question: "What is the capital of France?",
                    options: ["Paris", "London", "Berlin", "Madrid"],
                    correct: 0
                },
                {
                    question: "Which planet is known as the Red Planet?",
                    options: ["Mars", "Earth", "Jupiter", "Venus"],
                    correct: 0
                },
                {
                    question: "What is 5 + 7?",
                    options: ["12", "10", "11", "13"],
                    correct: 0
                },
                {
                    question: "Who painted the Mona Lisa?",
                    options: ["Leonardo da Vinci", "Vincent van Gogh", "Pablo Picasso", "Rembrandt"],
                    correct: 0
                },
                {
                    question: "What is the chemical symbol for Gold?",
                    options: ["Au", "Go", "Gd", "Ag"],
                    correct: 0
                },
                {
                    question: "How many colors are in a rainbow?",
                    options: ["7", "5", "6", "8"],
                    correct: 0
                },
                {
                    question: "Which animal is known as the 'King of the Jungle'?",
                    options: ["Lion", "Elephant", "Tiger", "Bear"],
                    correct: 0
                },
                {
                    question: "What is the largest ocean on Earth?",
                    options: ["Pacific", "Atlantic", "Indian", "Arctic"],
                    correct: 0
                },
                {
                    question: "Which element has the atomic number 1?",
                    options: ["Hydrogen", "Helium", "Oxygen", "Carbon"],
                    correct: 0
                },
                {
                    question: "What year did World War II end?",
                    options: ["1945", "1943", "1944", "1946"],
                    correct: 0
                },
                {
                    question: "What is the tallest mountain in the world?",
                    options: ["Mount Everest", "K2", "Kangchenjunga", "Lhotse"],
                    correct: 0
                },
                {
                    question: "Which country is known as the Land of the Rising Sun?",
                    options: ["Japan", "China", "Thailand", "India"],
                    correct: 0
                },
                {
                    question: "How many continents are there?",
                    options: ["7", "6", "5", "8"],
                    correct: 0
                },
                {
                    question: "What is the hardest natural substance on Earth?",
                    options: ["Diamond", "Gold", "Iron", "Platinum"],
                    correct: 0
                },
                {
                    question: "Who wrote 'Romeo and Juliet'?",
                    options: ["William Shakespeare", "Charles Dickens", "Jane Austen", "Mark Twain"],
                    correct: 0
                }
            ];
            
            // Shuffle and return requested number
            const shuffled = [...allQuestions].sort(() => Math.random() - 0.5);
            return shuffled.slice(0, count);
        }
        
        // ===== MULTIPLAYER FUNCTIONS =====
        function generateRoomCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }
        
        async function createRoom() {
            if (!gameState.userData) {
                alert("Please login first!");
                return;
            }
            
            showLoading(true);
            
            try {
                const roomCode = generateRoomCode();
                const roomRef = database.ref('rooms/' + roomCode);
                
                const playerData = {
                    id: gameState.user.uid,
                    username: gameState.userData.username || gameState.userData.displayName,
                    score: 0,
                    isHost: true,
                    isReady: false,
                    avatar: (gameState.userData.username || 'G').charAt(0).toUpperCase()
                };
                
                const roomData = {
                    code: roomCode,
                    hostId: gameState.user.uid,
                    hostName: gameState.userData.username || gameState.userData.displayName,
                    players: [playerData],
                    maxPlayers: 2,
                    status: 'waiting',
                    createdAt: Date.now(),
                    gameStarted: false,
                    currentQuestion: 0,
                    questions: []
                };
                
                await roomRef.set(roomData);
                
                // Set up room listener
                setupRoomListener(roomCode, roomRef);
                
                gameState.currentRoom = roomCode;
                gameState.roomRef = roomRef;
                
                showLoading(false);
                
                // Go to waiting room
                showWaitingRoom(roomCode);
                
            } catch (error) {
                showLoading(false);
                console.error("Error creating room:", error);
                alert("Error creating room. Please try again.");
            }
        }
        
        async function joinRoom() {
            const roomCode = document.getElementById('roomCodeInput').value.trim().toUpperCase();
            
            if (!roomCode) {
                alert("Please enter a room code!");
                return;
            }
            
            if (!gameState.userData) {
                alert("Please login first!");
                return;
            }
            
            showLoading(true);
            
            try {
                const roomRef = database.ref('rooms/' + roomCode);
                const snapshot = await roomRef.once('value');
                
                if (!snapshot.exists()) {
                    showLoading(false);
                    alert("Room not found!");
                    return;
                }
                
                const room = snapshot.val();
                
                if (room.status !== 'waiting') {
                    showLoading(false);
                    alert("Room is full or game has started!");
                    return;
                }
                
                if (room.players.length >= room.maxPlayers) {
                    showLoading(false);
                    alert("Room is full!");
                    return;
                }
                
                // Check if player already in room
                const playerExists = room.players.some(p => p.id === gameState.user.uid);
                if (playerExists) {
                    showLoading(false);
                    alert("You are already in this room!");
                    return;
                }
                
                // Add player to room
                const playerData = {
                    id: gameState.user.uid,
                    username: gameState.userData.username || gameState.userData.displayName,
                    score: 0,
                    isHost: false,
                    isReady: false,
                    avatar: (gameState.userData.username || 'G').charAt(0).toUpperCase()
                };
                
                const updatedPlayers = [...room.players, playerData];
                
                await roomRef.update({
                    players: updatedPlayers,
                    status: updatedPlayers.length >= room.maxPlayers ? 'full' : 'waiting'
                });
                
                // Set up room listener
                setupRoomListener(roomCode, roomRef);
                
                gameState.currentRoom = roomCode;
                gameState.roomRef = roomRef;
                
                showLoading(false);
                
                // Go to waiting room
                showWaitingRoom(roomCode);
                
            } catch (error) {
                showLoading(false);
                console.error("Error joining room:", error);
                alert("Error joining room. Please try again.");
            }
        }
        
        function setupRoomListener(roomCode, roomRef) {
            // Remove previous listener if exists
            if (gameState.roomListener) {
                gameState.roomListener();
            }
            
            gameState.roomListener = roomRef.on('value', (snapshot) => {
                const room = snapshot.val();
                if (!room) {
                    // Room deleted
                    if (gameState.currentRoom === roomCode) {
                        alert("Room has been closed by host.");
                        leaveRoom();
                    }
                    return;
                }
                
                updateWaitingRoom(room);
                
                // Start game if game started
                if (room.gameStarted && !gameState.multiplayerGameStarted) {
                    startMultiplayerGameProcess(room);
                }
            });
        }
        
        function showWaitingRoom(roomCode) {
            // Hide all pages, show waiting page
            document.querySelectorAll('.page').forEach(p => {
                p.classList.remove('active');
            });
            document.getElementById('waitingPage').classList.add('active');
            
            // Update room code display
            document.getElementById('roomCodeDisplay').textContent = roomCode;
            
            // Update navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
        }
        
        function updateWaitingRoom(room) {
            const playerList = document.getElementById('playerList');
            const waitingMessage = document.getElementById('waitingMessage');
            const startGameBtn = document.getElementById('startGameBtn');
            
            playerList.innerHTML = '';
            
            room.players.forEach((player) => {
                const playerItem = document.createElement('div');
                playerItem.className = 'player-item';
                
                playerItem.innerHTML = `
                    <div class="player-avatar" style="margin: 0 auto 10px; ${player.isHost ? 'border: 2px solid var(--secondary);' : ''}">
                        ${player.avatar || player.username.charAt(0).toUpperCase()}
                    </div>
                    <div style="font-weight: bold;">${player.username}</div>
                    <div style="font-size: 0.8rem; color: rgba(255,255,255,0.7);">
                        ${player.isHost ? 'Host' : 'Player'}
                    </div>
                    ${player.isReady ? '<div style="color: #00FF9D; font-size: 0.8rem; margin-top: 5px;">Ready ‚úì</div>' : ''}
                `;
                
                playerList.appendChild(playerItem);
            });
            
            // Update messages and buttons
            if (room.players.length < 2) {
                waitingMessage.textContent = 'Waiting for another player to join...';
                waitingMessage.style.color = '#FFD166';
                startGameBtn.style.display = 'none';
            } else if (!room.gameStarted) {
                waitingMessage.textContent = 'Both players joined! Click "Start Game" to begin.';
                waitingMessage.style.color = '#00FF9D';
                
                // Show start button for host
                const isHost = room.hostId === gameState.user.uid;
                if (isHost) {
                    startGameBtn.style.display = 'block';
                }
            } else {
                waitingMessage.textContent = 'Game starting...';
                waitingMessage.style.color = '#00FF9D';
                startGameBtn.style.display = 'none';
            }
        }
        
        async function startMultiplayerGame() {
            if (!gameState.currentRoom || !gameState.roomRef) return;
            
            try {
                // Mark player as ready
                const snapshot = await gameState.roomRef.once('value');
                const room = snapshot.val();
                
                const updatedPlayers = room.players.map(player => {
                    if (player.id === gameState.user.uid) {
                        return { ...player, isReady: true };
                    }
                    return player;
                });
                
                await gameState.roomRef.update({
                    players: updatedPlayers
                });
                
                // Generate questions if host
                if (room.hostId === gameState.user.uid) {
                    await generateMultiplayerQuestions();
                }
                
            } catch (error) {
                console.error("Error starting game:", error);
                alert("Error starting game: " + error.message);
            }
        }
        
        async function generateMultiplayerQuestions() {
            if (!gameState.currentRoom || !gameState.roomRef) return;
            
            showLoading(true);
            
            try {
                // Generate 5 questions for multiplayer
                const questions = getLocalQuestions(5, 'medium');
                
                if (questions && questions.length > 0) {
                    await gameState.roomRef.update({
                        questions: questions,
                        gameStarted: true,
                        status: 'playing',
                        currentQuestion: 0
                    });
                } else {
                    throw new Error("Failed to generate questions");
                }
                
                showLoading(false);
                
            } catch (error) {
                showLoading(false);
                console.error("Error generating questions:", error);
                alert("Error starting game. Please try again.");
            }
        }
        
        function startMultiplayerGameProcess(room) {
            gameState.gameMode = 'multi';
            gameState.multiplayerGameStarted = true;
            
            // Set opponent info
            const opponent = room.players.find(p => p.id !== gameState.user.uid);
            if (opponent) {
                gameState.opponentName = opponent.username;
                gameState.opponentScore = opponent.score || 0;
                document.getElementById('opponentName').textContent = opponent.username;
            }
            
            gameState.questions = room.questions || [];
            gameState.currentQuestion = 0;
            gameState.score = 0;
            
            // Go to game page
            goToPage('game');
            loadQuestion();
        }
        
        function copyRoomCode() {
            const roomCode = document.getElementById('roomCodeDisplay').textContent;
            navigator.clipboard.writeText(roomCode);
            
            // Show feedback
            const btn = event.target;
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
            btn.style.background = '#00FF9D';
            btn.style.color = '#000';
            
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.style.background = '';
                btn.style.color = '';
            }, 2000);
        }
        
        async function leaveRoom() {
            if (gameState.currentRoom && gameState.roomRef) {
                try {
                    const snapshot = await gameState.roomRef.once('value');
                    const room = snapshot.val();
                    
                    if (room) {
                        // Remove player from room
                        const updatedPlayers = room.players.filter(p => p.id !== gameState.user.uid);
                        
                        if (updatedPlayers.length === 0) {
                            // Delete room if empty
                            await gameState.roomRef.remove();
                        } else {
                            // Update room
                            const newHost = updatedPlayers[0];
                            await gameState.roomRef.update({
                                players: updatedPlayers,
                                status: updatedPlayers.length < 2 ? 'waiting' : 'full',
                                hostId: newHost.id,
                                hostName: newHost.username
                            });
                        }
                    }
                    
                    // Remove listener
                    if (gameState.roomListener) {
                        gameState.roomListener();
                        gameState.roomListener = null;
                    }
                    
                    gameState.currentRoom = null;
                    gameState.roomRef = null;
                    gameState.multiplayerGameStarted = false;
                    
                    // Go back to multiplayer page
                    goToPage('multi');
                    
                } catch (error) {
                    console.error("Error leaving room:", error);
                }
            }
        }
        
        async function loadActiveRooms() {
            try {
                const roomsRef = database.ref('rooms');
                roomsRef.on('value', (snapshot) => {
                    const rooms = snapshot.val();
                    const roomsContainer = document.getElementById('roomsContainer');
                    roomsContainer.innerHTML = '';
                    
                    if (!rooms) {
                        roomsContainer.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">No active rooms</p>';
                        return;
                    }
                    
                    let hasActiveRooms = false;
                    
                    for (const roomCode in rooms) {
                        const room = rooms[roomCode];
                        
                        // Show only waiting rooms with space
                        if (room.status === 'waiting' && room.players.length < room.maxPlayers) {
                            hasActiveRooms = true;
                            
                            const roomItem = document.createElement('div');
                            roomItem.className = 'room-item';
                            roomItem.innerHTML = `
                                <div>
                                    <strong>${room.hostName}'s Room</strong>
                                    <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">
                                        Players: ${room.players.length}/${room.maxPlayers}
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center;">
                                    <span class="room-code">${room.code}</span>
                                    <button class="copy-btn" onclick="copyRoomCodeFromList('${room.code}')">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                    <button class="copy-btn" onclick="joinSpecificRoom('${room.code}')" style="background: var(--primary);">
                                        Join
                                    </button>
                                </div>
                            `;
                            roomsContainer.appendChild(roomItem);
                        }
                    }
                    
                    if (!hasActiveRooms) {
                        roomsContainer.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">No active rooms available</p>';
                    }
                });
            } catch (error) {
                console.error("Error loading rooms:", error);
            }
        }
        
        function copyRoomCodeFromList(code) {
            navigator.clipboard.writeText(code);
            alert(`Room code ${code} copied to clipboard!`);
        }
        
        function joinSpecificRoom(code) {
            document.getElementById('roomCodeInput').value = code;
            joinRoom();
        }
        
        // ===== GAME FUNCTIONS =====
        async function startGame(difficulty) {
            showLoading(true);
            
            const questionCount = difficulty === 'easy' ? 5 : difficulty === 'medium' ? 7 : 10;
            
            try {
                gameState.questions = getLocalQuestions(questionCount, difficulty);
                gameState.currentQuestion = 0;
                gameState.score = 0;
                gameState.opponentScore = 0;
                gameState.gameMode = 'single';
                gameState.opponentName = 'AI Opponent';
                
                document.getElementById('opponentName').textContent = gameState.opponentName;
                
                goToPage('game');
                loadQuestion();
                
            } catch (error) {
                console.error("Error starting game:", error);
                alert("Error starting game. Please try again.");
            } finally {
                showLoading(false);
            }
        }
        
        function loadQuestion() {
            if (gameState.currentQuestion >= gameState.questions.length) {
                endGame();
                return;
            }
            
            const question = gameState.questions[gameState.currentQuestion];
            document.getElementById('questionText').textContent = question.question;
            
            // Update scores
            document.getElementById('playerScore').textContent = gameState.score;
            document.getElementById('opponentScore').textContent = gameState.opponentScore;
            
            // Load options
            const optionsGrid = document.getElementById('optionsGrid');
            optionsGrid.innerHTML = '';
            
            const letters = ['A', 'B', 'C', 'D'];
            question.options.forEach((option, index) => {
                const optionBtn = document.createElement('div');
                optionBtn.className = 'option';
                optionBtn.innerHTML = `
                    <div style="width: 30px; height: 30px; background: rgba(255,255,255,0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                        ${letters[index]}
                    </div>
                    <div>${option}</div>
                `;
                
                optionBtn.onclick = () => selectAnswer(index, question);
                optionsGrid.appendChild(optionBtn);
            });
            
            // Start timer
            startTimer();
        }
        
        function startTimer() {
            let timeLeft = 20;
            document.getElementById('timer').textContent = timeLeft;
            
            // Clear existing timer
            if (gameState.timer) {
                clearInterval(gameState.timer);
            }
            
            gameState.timer = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(gameState.timer);
                    handleTimeout();
                }
            }, 1000);
        }
        
        async function selectAnswer(selectedIndex, question) {
            clearInterval(gameState.timer);
            
            // Disable all options
            document.querySelectorAll('.option').forEach(opt => {
                opt.style.pointerEvents = 'none';
            });
            
            const isCorrect = selectedIndex === question.correct;
            
            // Mark correct/incorrect
            document.querySelectorAll('.option').forEach((opt, index) => {
                if (index === question.correct) {
                    opt.classList.add('correct');
                } else if (index === selectedIndex && !isCorrect) {
                    opt.classList.add('wrong');
                }
            });
            
            // Update score
            if (isCorrect) {
                gameState.score += 100;
                showFeedback('Correct! +100 points', '#00FF9D');
            } else {
                showFeedback('Wrong!', '#FF6B8B');
            }
            
            // Update multiplayer score if in multiplayer
            if (gameState.gameMode === 'multi' && gameState.currentRoom && gameState.roomRef) {
                try {
                    await updateMultiplayerScore();
                } catch (error) {
                    console.error("Error updating multiplayer score:", error);
                }
            } else {
                // Simulate AI opponent in single player
                if (Math.random() > 0.4) {
                    gameState.opponentScore += 100;
                }
            }
            
            // Update display
            document.getElementById('playerScore').textContent = gameState.score;
            document.getElementById('opponentScore').textContent = gameState.opponentScore;
            
            // Update multiplayer opponent score in real-time
            if (gameState.gameMode === 'multi' && gameState.currentRoom && gameState.roomRef) {
                try {
                    await updateOpponentScoreInRoom();
                } catch (error) {
                    console.error("Error updating opponent score:", error);
                }
            }
            
            // Next question
            setTimeout(() => {
                gameState.currentQuestion++;
                loadQuestion();
            }, 2000);
        }
        
        async function updateMultiplayerScore() {
            if (!gameState.currentRoom || !gameState.roomRef) return;
            
            try {
                const snapshot = await gameState.roomRef.once('value');
                const room = snapshot.val();
                
                const updatedPlayers = room.players.map(player => {
                    if (player.id === gameState.user.uid) {
                        return { ...player, score: gameState.score };
                    }
                    return player;
                });
                
                await gameState.roomRef.update({
                    players: updatedPlayers
                });
            } catch (error) {
                throw error;
            }
        }
        
        async function updateOpponentScoreInRoom() {
            if (!gameState.currentRoom || !gameState.roomRef) return;
            
            try {
                const snapshot = await gameState.roomRef.once('value');
                const room = snapshot.val();
                
                const opponent = room.players.find(p => p.id !== gameState.user.uid);
                if (opponent) {
                    gameState.opponentScore = opponent.score || 0;
                    document.getElementById('opponentScore').textContent = gameState.opponentScore;
                }
            } catch (error) {
                console.error("Error updating opponent score:", error);
            }
        }
        
        function handleTimeout() {
            showFeedback("Time's up!", '#FFD166');
            
            // Simulate AI answer in single player
            if (gameState.gameMode === 'single' && Math.random() > 0.5) {
                gameState.opponentScore += 100;
                document.getElementById('opponentScore').textContent = gameState.opponentScore;
            }
            
            setTimeout(() => {
                gameState.currentQuestion++;
                loadQuestion();
            }, 1500);
        }
        
        function showFeedback(message, color) {
            const feedback = document.createElement('div');
            feedback.style.position = 'fixed';
            feedback.style.top = '50%';
            feedback.style.left = '50%';
            feedback.style.transform = 'translate(-50%, -50%)';
            feedback.style.background = color + '20';
            feedback.style.color = color;
            feedback.style.padding = '15px 25px';
            feedback.style.borderRadius = '10px';
            feedback.style.fontWeight = 'bold';
            feedback.style.zIndex = '1001';
            feedback.style.border = `2px solid ${color}`;
            feedback.style.backdropFilter = 'blur(10px)';
            feedback.textContent = message;
            
            document.body.appendChild(feedback);
            
            setTimeout(() => {
                feedback.remove();
            }, 1500);
        }
        
        async function endGame() {
            clearInterval(gameState.timer);
            
            // Calculate result
            let resultMessage = '';
            let isWinner = false;
            
            if (gameState.score > gameState.opponentScore) {
                resultMessage = `You Win! üèÜ\nScore: ${gameState.score} vs ${gameState.opponentScore}`;
                isWinner = true;
            } else if (gameState.score < gameState.opponentScore) {
                resultMessage = `You Lose üò¢\nScore: ${gameState.score} vs ${gameState.opponentScore}`;
            } else {
                resultMessage = `Draw! ü§ù\nScore: ${gameState.score} vs ${gameState.opponentScore}`;
            }
            
            // Update user stats
            const updates = {
                games: (gameState.userData.games || 0) + 1
            };
            
            if (isWinner) {
                updates.wins = (gameState.userData.wins || 0) + 1;
                updates.points = (gameState.userData.points || 0) + gameState.score;
            }
            
            updates.level = Math.floor((updates.points || gameState.userData.points || 0) / 1000) + 1;
            
            await updateUserStats(updates);
            
            // Clean up multiplayer room
            if (gameState.gameMode === 'multi' && gameState.currentRoom) {
                // Show multiplayer result
                showGameOverMultiplayer(resultMessage);
                
                // Delete room after game ends
                setTimeout(() => {
                    if (gameState.roomRef) {
                        gameState.roomRef.remove();
                    }
                    gameState.currentRoom = null;
                    gameState.roomRef = null;
                    gameState.multiplayerGameStarted = false;
                }, 5000);
            } else {
                // Single player result
                showGameOver(resultMessage);
            }
        }
        
        function showGameOver(message) {
            const gameOverHTML = `
                <div class="game-over">
                    <div style="font-size: 2rem; margin-bottom: 15px; color: var(--secondary);">Game Over!</div>
                    <div style="margin-bottom: 20px; color: rgba(255,255,255,0.8); white-space: pre-line; font-size: 1.2rem;">${message}</div>
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="goToPage('home')" style="padding: 12px 25px; background: #7B68EE; border: none; border-radius: 10px; color: white; font-weight: bold; cursor: pointer;">
                            Back to Home
                        </button>
                        <button onclick="goToPage('single')" style="padding: 12px 25px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: white; font-weight: bold; cursor: pointer;">
                            Play Again
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('questionText').innerHTML = gameOverHTML;
            document.getElementById('optionsGrid').innerHTML = '';
            document.getElementById('timer').style.display = 'none';
        }
        
        function showGameOverMultiplayer(message) {
            const gameOverHTML = `
                <div class="game-over">
                    <div style="font-size: 2rem; margin-bottom: 15px; color: var(--secondary);">Game Over!</div>
                    <div style="margin-bottom: 20px; color: rgba(255,255,255,0.8); white-space: pre-line; font-size: 1.2rem;">${message}</div>
                    <div style="margin-bottom: 20px; font-size: 1.1rem; color: #FFD166;">
                        Returning to multiplayer in 5 seconds...
                    </div>
                    <button onclick="leaveRoom()" style="padding: 12px 25px; background: #7B68EE; border: none; border-radius: 10px; color: white; font-weight: bold; cursor: pointer;">
                        Back to Multiplayer
                    </button>
                </div>
            `;
            
            document.getElementById('questionText').innerHTML = gameOverHTML;
            document.getElementById('optionsGrid').innerHTML = '';
            document.getElementById('timer').style.display = 'none';
            
            setTimeout(() => {
                leaveRoom();
            }, 5000);
        }
        
        // ===== GLOBAL FUNCTIONS =====
        window.loginWithEmail = loginWithEmail;
        window.signupWithEmail = signupWithEmail;
        window.loginAsGuest = loginAsGuest;
        window.logout = logout;
        window.goToPage = goToPage;
        window.startGame = startGame;
        window.createRoom = createRoom;
        window.joinRoom = joinRoom;
        window.copyRoomCode = copyRoomCode;
        window.copyRoomCodeFromList = copyRoomCodeFromList;
        window.joinSpecificRoom = joinSpecificRoom;
        window.startMultiplayerGame = startMultiplayerGame;
        window.leaveRoom = leaveRoom;
        window.showAuthForm = showAuthForm;
    </script>
</body>
</html>
